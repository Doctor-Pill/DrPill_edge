import cv2
import socket
import threading
import subprocess
import os
import signal
import time

# ========== ì„¤ì • ==========
TARGET_IP = "192.168.0.10"  # ì›Œí¬ìŠ¤í…Œì´ì…˜ IP
TARGET_PORT = 5000
DEVICE_USB = "/dev/video0"

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (GUI ë””ìŠ¤í”Œë ˆì´ìš©)
os.environ["DISPLAY"] = ":0"

# ========== í†µì‹  ì†Œì¼“ ==========
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

# ========== ì „ì—­ ì œì–´ ==========
tx_thread = None
stop_event = threading.Event()

# ========== ì ìœ  í•´ì œ ìœ í‹¸ ==========
def free_device(device_path):
    """ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì¹´ë©”ë¼ ì ìœ  ì¤‘ì´ë©´ ê°•ì œ ì¢…ë£Œ"""
    try:
        result = subprocess.check_output(["fuser", device_path])
        pids = result.decode().strip().split()
        for pid in pids:
            pid = int(pid)
            if pid == os.getpid():
                continue
            try:
                os.kill(pid, signal.SIGKILL)
                print(f"âš¡ {device_path} ì ìœ  ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ {pid} ì¢…ë£Œ")
                time.sleep(1)  # ë¦¬ì†ŒìŠ¤ ë°˜ë‚© ëŒ€ê¸°
            except Exception as e:
                print(f"âš ï¸ ì¢…ë£Œ ì‹¤íŒ¨: {e}")
    except subprocess.CalledProcessError:
        print(f"âœ… {device_path}ëŠ” ì ìœ ë˜ì§€ ì•ŠìŒ")

# ========== ì¹´ë©”ë¼ ì—´ê¸° (ì¬ì‹œë„ í¬í•¨) ==========
def try_open_camera(device_path, retries=2):
    for i in range(retries):
        cap = cv2.VideoCapture(device_path)
        time.sleep(0.5)
        if cap.isOpened():
            print(f"âœ… ì¹´ë©”ë¼ ì—´ê¸° ì„±ê³µ: {device_path}")
            return cap
        if i == 0:
            print(f"âš ï¸ ì²« ì‹œë„ ì‹¤íŒ¨ â†’ ì ìœ  í•´ì œ ì‹œë„: {device_path}")
            free_device(device_path)
    print(f"âŒ ì¹´ë©”ë¼ ì—´ê¸° ì‹¤íŒ¨: {device_path}")
    return None

# ========== ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ==========
def start_usb_streaming():
    start_streaming(DEVICE_USB)

def start_picam_streaming():
    print("âš ï¸ PiCam ìŠ¤íŠ¸ë¦¬ë°ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

def start_streaming(device_path):
    print(device_path, "streaming í•´ë³´ì~~")
    global tx_thread, stop_event

    stop_all_streaming()
    stop_event.clear()

    def streaming_loop():
        cap = try_open_camera(device_path)
        if not cap or not cap.isOpened():
            return

        cv2.namedWindow('Camera Stream', cv2.WND_PROP_FULLSCREEN)
        cv2.setWindowProperty('Camera Stream', cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)

        print(f"ğŸš€ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘: {device_path}")

        while not stop_event.is_set():
            ret, frame = cap.read()
            if not ret:
                print("âš ï¸ í”„ë ˆì„ ì½ê¸° ì‹¤íŒ¨")
                break

            frame = cv2.flip(frame, 1)
            frame = cv2.resize(frame, (800, 480))
            cv2.imshow('Camera Stream', frame)

            ret, buffer = cv2.imencode('.jpg', frame, [int(cv2.IMWRITE_JPEG_QUALITY), 80])
            if ret:
                try:
                    sock.sendto(buffer.tobytes(), (TARGET_IP, TARGET_PORT))
                except Exception as e:
                    print(f"â— ì†¡ì‹  ì—ëŸ¬: {e}")

            if cv2.waitKey(10) == 27:
                print("ğŸ›‘ ESC í‚¤ ì…ë ¥ìœ¼ë¡œ ì¢…ë£Œ")
                stop_event.set()
                break

        cap.release()
        cv2.destroyAllWindows()
        print("ğŸ§Š ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ")

    tx_thread = threading.Thread(target=streaming_loop)
    tx_thread.start()

# ========== ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨ ==========
def stop_all_streaming():
    global tx_thread, stop_event
    if tx_thread and tx_thread.is_alive():
        print("ğŸ›‘ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨ ìš”ì²­")
        stop_event.set()
        tx_thread.join()
    tx_thread = None
    stop_event.clear()